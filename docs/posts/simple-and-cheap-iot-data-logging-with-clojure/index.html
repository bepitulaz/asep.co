<!DOCTYPE html>
<html lang="en-gb">

  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <meta name="author" content="Asep Bagja Priandana">
    <meta name="description" content="My personal blog">
    <meta name="keywords" content="blog,developer,personal">

    <base href="http://asepbagja.com/">
    <title>
  Simple, Cheap, and Scalable IoT Data Logging With Clojure · Asep&#39;s Notes
</title>

    <link rel="canonical" href="http://asepbagja.com/posts/simple-and-cheap-iot-data-logging-with-clojure/">

    <link  rel="stylesheet" href="https://fonts.googleapis.com/css?family=Fira+Mono:400,700">
    <link rel="stylesheet" href="//cdn.rawgit.com/necolas/normalize.css/master/normalize.css">
    <link rel="stylesheet" href="http://asepbagja.com/css/style.min.css">

    <link rel="icon" type="image/png" href="http://asepbagja.com/images/favicon-32x32.png" sizes="32x32">
    <link rel="icon" type="image/png" href="http://asepbagja.com/images/favicon-16x16.png" sizes="16x16">

    

    <meta name="generator" content="Hugo 0.37" />
  </head>

  <body>
    <main class="wrapper">
      <nav class="navigation">
  <section class="container">
    <a class="navigation-title" href="http://asepbagja.com/">
      Asep&#39;s Notes
    </a>
    
    <ul class="navigation-list float-right">
      
      <li class="navigation-item">
        <a class="navigation-link" href="http://asepbagja.com/posts/">Blog</a>
      </li>
      
      <li class="navigation-item">
        <a class="navigation-link" href="http://asepbagja.com/about/">About</a>
      </li>
      
    </ul>
    
  </section>
</nav>


      <div class="content">
        
  <section class="container post">
  <article>
    <header>
      <h1 class="title">Simple, Cheap, and Scalable IoT Data Logging With Clojure</h1>
      <h2 class="date">December 8, 2015</h2>
    </header>

    <p>I have a small green house in <a href="https://asep.co/my-familys-journey-to-grow-our-own-food/">my home front yard</a>, and I deployed some sensors like temperature, humidity, electrical conductivity (EC), and pH sensor there.</p>

<p>After the development of the sensors completed, it was the time for me to develop the web service for logging the data. I considered to use NoSQL database for persistent data storage. Otherwise I dismissed that idea for the sake of cost efficiency.</p>

<p>To use NoSQL database, I should open one or two servers in cloud provider for running it. As we know, the cost for compute engine is charged per hour. Let&rsquo;s pick AWS EC2 for the example. T2.small instance pricing is $0.04/hour. That&rsquo;s too expensive for non-profit purpose.</p>

<p><strong>The solution</strong></p>

<p>I decided to make my own NoSQL solution. Persisted all data logs to plain text and put it on AWS S3. That&rsquo;s cheaper, because S3 is storage server and it is charged per GB. For the first 1 TB, it only costs me $0.02/GB. It will takes a long time to reach 1 GB, if only for saving plain text.</p>

<p>The concept is simple. Just catch the string from the sensor, transform it into Clojure data structure, and save it inside the plain text file. To query it back, I just need to read the plain text file, transform the string back into Clojure data structure, and do the computation.</p>

<p>Here is the snippet code for writing and querying the data.</p>
<div class="highlight"><pre style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4">(ns data-logging.core
  (:require [clojure.string :as str]
            [clojure.walk :as walk]
            [clojure.java.io :as io]
            [clj-time.coerce :as coerce]
            [clj-time.local :as l]))

(defn data-parser
  &#34;Parsing data from sensor.&#34;
  [raw-string]
  (let [split-data (str/split raw-string #&#34;,&#34;)
        flatten-data (-&gt;
                      (map #(str/split % #&#34;=&#34;) split-data)
                      (flatten))]
    (-&gt; (apply hash-map flatten-data)
        (walk/keywordize-keys))))

(defn write-today-log
  &#34;Write today log file.&#34;
  [sensor-data file-name]
  ;; check if file already exist
  (if (io/.exists (io/as-file file-name))
    ;; exist: append new hash map to vector.
    (let [existing-data (read-string (slurp file-name))]
      (spit file-name 
            (with-out-str
              (pr 
               (conj existing-data (data-parser sensor-data))))))
    ;; not exist: create new file and insert the vector of hash map.
    (spit file-name 
          (with-out-str 
            (pr (conj [] (data-parser sensor-data)))))))

(defn search-log
  &#34;Search data between two times.&#34;
  [start-time end-time file-name]
  ;; update the date time string to timestamp 
  (let [log-data (read-string (slurp file-name))
        with-timestamp (map 
                        #(update-in % [:datetime] coerce/to-long) 
                        log-data)]
    ;; let&#39;s find the data!
    (let [result (filter #(and 
                           (&gt; (:datetime %) (coerce/to-long start-time))
                           (&lt; (:datetime %) (coerce/to-long end-time)))
                         with-timestamp)]
      ;; here is the result
      (map #(update-in % [:datetime]
                       (fn [x]
                         (l/format-local-time
                          (coerce/from-long x)
                          :mysql))) result))))</pre></div>
<p>This is how to use it.</p>
<div class="highlight"><pre style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4">;; Saving the sensor data
(write-today-log &#34;sensorid=123,temp=31.52,humidity=45.4,datetime=2015-12-08 17:31:30&#34; &#34;today-2015-12-08.log&#34;)

;; Querying the data
(search-log &#34;2015-12-08 14:00:00&#34; &#34;2015-12-08 19:00:00&#34; &#34;today-2015-12-08.log&#34;)</pre></div>
<p>Someday if I can get profit from my greenhouse and I need to scale this system, I just need to export the log into another data storage technology. It&rsquo;s simple, cheap, and scalable.</p>

  </article>
</section>


      </div>

      <footer class="footer">
  <section class="container">
    © 2016 · Powered by <a href="https://gohugo.io/">Hugo</a> & <a href="https://github.com/luizdepra/hugo-coder/">Coder</a>.
  </section>
</footer>

    </main>

    

  </body>

</html>
