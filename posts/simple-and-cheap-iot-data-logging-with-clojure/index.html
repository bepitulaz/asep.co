<!doctype html>
<html lang="en-gb"><head>
    
<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
	ga('create', 'UA-136771948-2', 'auto');
	
	ga('send', 'pageview');
}
</script>
<script async src='https://www.google-analytics.com/analytics.js'></script>


    
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

    
    <meta name="description" content="I have a small green house in my home front yard, and I deployed some sensors like temperature, humidity, electrical conductivity (EC), and pH sensor there.">

    
    <meta property="og:title" content="Simple, Cheap, and Scalable IoT Data Logging With Clojure" />
<meta property="og:description" content="I have a small green house in my home front yard, and I deployed some sensors like temperature, humidity, electrical conductivity (EC), and pH sensor there." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://asepbagja.com/posts/simple-and-cheap-iot-data-logging-with-clojure/" />

<meta property="og:image" content="https://upload.wikimedia.org/wikipedia/commons/thumb/5/5d/Clojure_logo.svg/500px-Clojure_logo.svg.png" />
<meta property="article:published_time" content="2015-12-08T00:00:00+00:00" />
<meta property="article:modified_time" content="2015-12-08T00:00:00+00:00" /><meta property="og:site_name" content="The Tech Entrepreneur and Consultant" />


    
    <meta name="twitter:card" content="summary_large_image"/>
<meta name="twitter:image" content="https://upload.wikimedia.org/wikipedia/commons/thumb/5/5d/Clojure_logo.svg/500px-Clojure_logo.svg.png"/>

<meta name="twitter:title" content="Simple, Cheap, and Scalable IoT Data Logging With Clojure"/>
<meta name="twitter:description" content="I have a small green house in my home front yard, and I deployed some sensors like temperature, humidity, electrical conductivity (EC), and pH sensor there."/>



    <link href="/css/plugins.css" rel="stylesheet">
    <link href="/css/style.css" rel="stylesheet">
    <link href="/css/responsive.css" rel="stylesheet">

    <title>Simple, Cheap, and Scalable IoT Data Logging With Clojure - The Tech Entrepreneur and Consultant</title>

    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/cookieconsent@3/build/cookieconsent.min.css" />
    <script src="https://cdn.jsdelivr.net/npm/cookieconsent@3/build/cookieconsent.min.js" data-cfasync="false"></script>
    <script>
    window.addEventListener("load", function(){
    window.cookieconsent.initialise({
      "palette": {
        "popup": {
          "background": "#efefef",
          "text": "#404040"
        },
        "button": {
          "background": "#8ec760",
          "text": "#ffffff"
        }
      },
      "position": "bottom"
    })});
    </script>
</head>
<body>
    <div class="body-inner">
<div id="topbar" class="topbar-fullwidth d-none d-xl-block d-lg-block">
  <div class="container">
    <div class="row">
      <div class="col-12 d-none d-sm-block">
        <div class="social-icons social-icons-colored-hover">
          <ul>
            <li class="social-twitter"><a href="https://twitter.com/bepitulaz"><i class="fab fa-twitter"></i></a></li>
            <li class="social-linkedin"><a href="https://www.linkedin.com/in/asepbagja"><i class="fab fa-linkedin"></i></a></li>
            <li class="social-youtube"><a href="https://www.youtube.com/channel/UCjGnuWk0n6BWx7rXshMysbw"><i class="fab fa-youtube"></i></a></li>
          </ul>
        </div>
      </div>
    </div>
  </div>
</div>

<header id="header" data-fullwidth="true">
  <div class="header-inner">
    <div class="container">
      
      <div id="logo">
        <a href="/" class="ASPBGJ logo">
          ASPBGJ
        </a>
      </div>
      

      
      <div class="header-extras">
        <ul>
          <li>
            <div class="p-dropdown">
              <a href="#"><i class="icon-flag11"></i></a>
              <ul class="p-dropdown-content">
                
                <li><a href="https://asepbagja.com/">English</a></li>
                
                <li><a href="https://asepbagja.com/id/">Bahasa Indonesia</a></li>
                
              </ul>
            </div>
          </li>
        </ul>
      </div>
      

      
      <div id="mainMenu-trigger">
        <button class="lines-button x"> <span class="lines"></span> </button>
      </div>
      

      
      <div id="mainMenu">
        <nav>
          <ul><li class="">
              <a href="/">Home</a>
            </li>
            <li class="">
              <a href="/about">About</a>
            </li>
            <li class="">
              <a href="/posts">Posts</a>
            </li>
          </ul>
        </nav>
      </div>
      
    </div>
  </div>
</header>

<section id="page-content" class="sidebar-right">
  <div class="container">
    <div class="row">
      
      <div class="content col-lg-10 offset-lg-1">
        
        <div id="blog" class="single-post">
          
          <div class="post-item">
            <div class="post-item-wrap">
              <div class="post-item-description">
                <h2>Simple, Cheap, and Scalable IoT Data Logging With Clojure</h2>
                <div class="post-meta">
                    
                    <span class="post-meta-date"><i class="fa fa-calendar-o"></i>Dec, 8 2015</span>
                    <span class="post-meta-category">
                    
                      
                      
                      <i class="fa fa-tag"></i> <a href="https://asepbagja.com/categories/programming/">Programming</a>
                      
                    
                    </span>
                    <div class="post-meta-share">
                      


<style>
#share-buttons {display: inline-block; vertical-align: middle; }
#share-buttons:after {content: ""; display: block; clear: both;}
#share-buttons > div {
position: relative;
text-align: left;
height: 36px;
width: 32px;
float: left;
text-align: center;
}
#share-buttons > div > svg {height: 16px; fill: #d5d5d5; margin-top: 10px;}
#share-buttons > div:hover {cursor: pointer;}
#share-buttons > div.facebook:hover > svg {fill: #3B5998;}
#share-buttons > div.twitter:hover > svg {fill: #55ACEE;}
#share-buttons > div.linkedin:hover > svg {fill: #0077b5;}
#share-buttons > div.pinterest:hover > svg {fill: #CB2027;}
#share-buttons > div.gplus:hover > svg {fill: #dd4b39;}
#share-buttons > div.mail:hover > svg {fill: #7D7D7D;}
#share-buttons > div.instagram:hover > svg {fill: #C73B92;}
#share-buttons > div.facebook > svg {height: 18px; margin-top: 9px;}
#share-buttons > div.twitter > svg {height: 20px; margin-top: 8px;}
#share-buttons > div.linkedin > svg {height: 19px; margin-top: 7px;}
#share-buttons > div.pinterest > svg {height: 20px; margin-top: 9px;}
#share-buttons > div.gplus > svg {height: 17px; margin-top: 9px; position: relative; left: 1px;}
#share-buttons > div.mail > svg {height: 14px; margin-top: 11px;}
</style>

<div id="share-buttons">
<div class="facebook" title="Share this on Facebook" onclick="window.open('http://www.facebook.com/share.php?u=https:\/\/asepbagja.com\/\/posts\/simple-and-cheap-iot-data-logging-with-clojure\/');"><svg viewBox="0 0 1792 1792" xmlns="http://www.w3.org/2000/svg"><path d="M1343 12v264h-157q-86 0-116 36t-30 108v189h293l-39 296h-254v759h-306v-759h-255v-296h255v-218q0-186 104-288.5t277-102.5q147 0 228 12z"/></svg></div>
<div class="twitter" title="Share this on Twitter" onclick="window.open('http://twitter.com/home?status=https:\/\/asepbagja.com\/\/posts\/simple-and-cheap-iot-data-logging-with-clojure\/');"><svg viewBox="0 0 1792 1792" xmlns="http://www.w3.org/2000/svg"><path d="M1684 408q-67 98-162 167 1 14 1 42 0 130-38 259.5t-115.5 248.5-184.5 210.5-258 146-323 54.5q-271 0-496-145 35 4 78 4 225 0 401-138-105-2-188-64.5t-114-159.5q33 5 61 5 43 0 85-11-112-23-185.5-111.5t-73.5-205.5v-4q68 38 146 41-66-44-105-115t-39-154q0-88 44-163 121 149 294.5 238.5t371.5 99.5q-8-38-8-74 0-134 94.5-228.5t228.5-94.5q140 0 236 102 109-21 205-78-37 115-142 178 93-10 186-50z"/></svg></div>
<div class="linkedin" title="Share this on Linkedin" onclick="window.open('https://www.linkedin.com/shareArticle?mini=true&url=https:\/\/asepbagja.com\/\/posts\/simple-and-cheap-iot-data-logging-with-clojure\/&title=&summary=&source=');"><svg viewBox="0 0 1792 1792" xmlns="http://www.w3.org/2000/svg"><path d="M477 625v991h-330v-991h330zm21-306q1 73-50.5 122t-135.5 49h-2q-82 0-132-49t-50-122q0-74 51.5-122.5t134.5-48.5 133 48.5 51 122.5zm1166 729v568h-329v-530q0-105-40.5-164.5t-126.5-59.5q-63 0-105.5 34.5t-63.5 85.5q-11 30-11 81v553h-329q2-399 2-647t-1-296l-1-48h329v144h-2q20-32 41-56t56.5-52 87-43.5 114.5-15.5q171 0 275 113.5t104 332.5z"/></svg></div>

<div class="mail" title="Share this through Email" onclick="window.open('mailto:?&body=https:\/\/asepbagja.com\/\/posts\/simple-and-cheap-iot-data-logging-with-clojure\/');"><svg viewBox="0 0 1792 1792" xmlns="http://www.w3.org/2000/svg"><path d="M1792 710v794q0 66-47 113t-113 47h-1472q-66 0-113-47t-47-113v-794q44 49 101 87 362 246 497 345 57 42 92.5 65.5t94.5 48 110 24.5h2q51 0 110-24.5t94.5-48 92.5-65.5q170-123 498-345 57-39 100-87zm0-294q0 79-49 151t-122 123q-376 261-468 325-10 7-42.5 30.5t-54 38-52 32.5-57.5 27-50 9h-2q-23 0-50-9t-57.5-27-52-32.5-54-38-42.5-30.5q-91-64-262-182.5t-205-142.5q-62-42-117-115.5t-55-136.5q0-78 41.5-130t118.5-52h1472q65 0 112.5 47t47.5 113z"/></svg></div>
</div>

                    </div>
                </div>
              </div>
              <p>I have a small green house in <a href="https://asep.co/my-familys-journey-to-grow-our-own-food/">my home front yard</a>, and I deployed some sensors like temperature, humidity, electrical conductivity (EC), and pH sensor there.</p>

<p>After the development of the sensors completed, it was the time for me to develop the web service for logging the data. I considered to use NoSQL database for persistent data storage. Otherwise I dismissed that idea for the sake of cost efficiency.</p>

<p>To use NoSQL database, I should open one or two servers in cloud provider for running it. As we know, the cost for compute engine is charged per hour. Let&rsquo;s pick AWS EC2 for the example. T2.small instance pricing is $0.04/hour. That&rsquo;s too expensive for non-profit purpose.</p>

<p><strong>The solution</strong></p>

<p>I decided to make my own NoSQL solution. Persisted all data logs to plain text and put it on AWS S3. That&rsquo;s cheaper, because S3 is storage server and it is charged per GB. For the first 1 TB, it only costs me $0.02/GB. It will takes a long time to reach 1 GB, if only for saving plain text.</p>

<p>The concept is simple. Just catch the string from the sensor, transform it into Clojure data structure, and save it inside the plain text file. To query it back, I just need to read the plain text file, transform the string back into Clojure data structure, and do the computation.</p>

<p>Here is the snippet code for writing and querying the data.</p>

<pre><code>(ns data-logging.core
  (:require [clojure.string :as str]
            [clojure.walk :as walk]
            [clojure.java.io :as io]
            [clj-time.coerce :as coerce]
            [clj-time.local :as l]))

(defn data-parser
  &quot;Parsing data from sensor.&quot;
  [raw-string]
  (let [split-data (str/split raw-string #&quot;,&quot;)
        flatten-data (-&gt;
                      (map #(str/split % #&quot;=&quot;) split-data)
                      (flatten))]
    (-&gt; (apply hash-map flatten-data)
        (walk/keywordize-keys))))

(defn write-today-log
  &quot;Write today log file.&quot;
  [sensor-data file-name]
  ;; check if file already exist
  (if (io/.exists (io/as-file file-name))
    ;; exist: append new hash map to vector.
    (let [existing-data (read-string (slurp file-name))]
      (spit file-name
            (with-out-str
              (pr
               (conj existing-data (data-parser sensor-data))))))
    ;; not exist: create new file and insert the vector of hash map.
    (spit file-name
          (with-out-str
            (pr (conj [] (data-parser sensor-data)))))))

(defn search-log
  &quot;Search data between two times.&quot;
  [start-time end-time file-name]
  ;; update the date time string to timestamp
  (let [log-data (read-string (slurp file-name))
        with-timestamp (map
                        #(update-in % [:datetime] coerce/to-long)
                        log-data)]
    ;; let's find the data!
    (let [result (filter #(and
                           (&gt; (:datetime %) (coerce/to-long start-time))
                           (&lt; (:datetime %) (coerce/to-long end-time)))
                         with-timestamp)]
      ;; here is the result
      (map #(update-in % [:datetime]
                       (fn [x]
                         (l/format-local-time
                          (coerce/from-long x)
                          :mysql))) result))))
</code></pre>

<p>This is how to use it.</p>

<pre><code>;; Saving the sensor data
(write-today-log &quot;sensorid=123,temp=31.52,humidity=45.4,datetime=2015-12-08 17:31:30&quot; &quot;today-2015-12-08.log&quot;)

;; Querying the data
(search-log &quot;2015-12-08 14:00:00&quot; &quot;2015-12-08 19:00:00&quot; &quot;today-2015-12-08.log&quot;)
</code></pre>

<p>Someday if I can get profit from my greenhouse and I need to scale this system, I just need to export the log into another data storage technology. It&rsquo;s simple, cheap, and scalable.</p>

              <div class="comments" id="comments">
                <div id="disqus_thread"></div>
<script type="application/javascript">
    var disqus_config = function () {
    
    
    
    };
    (function() {
        if (["localhost", "127.0.0.1"].indexOf(window.location.hostname) != -1) {
            document.getElementById('disqus_thread').innerHTML = 'Disqus comments not available by default when the website is previewed locally.';
            return;
        }
        var d = document, s = d.createElement('script'); s.async = true;
        s.src = '//' + "asepnew" + '.disqus.com/embed.js';
        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="https://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
              </div>
            </div>
          </div>
        </div>
        
      </div>
    </div>
  </div>
</section>

<script type="text/javascript" src="//downloads.mailchimp.com/js/signup-forms/popup/unique-methods/embed.js" data-dojo-config="usePlainJson: true, isDebug: false"></script><script type="text/javascript">window.dojoRequire(["mojo/signup-forms/Loader"], function(L) { L.start({"baseUrl":"mc.us3.list-manage.com","uuid":"9d7b2c9f4c0bebc73fcfe5d85","lid":"0c177e8e7d","uniqueMethods":true}) })</script>
<footer id="footer" class="inverted">
  <div class="copyright-content">
    <div class="container">
      <div class="copyright-text text-center">&copy; 2019 Asep Bagja Priandana. All Rights Reserved.</div>
    </div>
  </div>
</footer>

</div>

    <a id="scrollTop"><i class="icon-chevron-up1"></i><i class="icon-chevron-up1"></i></a>

    <script src="/js/jquery.js"></script>
    <script src="/js/plugins.js"></script>
    <script src="/js/functions.js"></script>
  </body>
</html>
